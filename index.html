<!--
  Pocket Full of Sunshine
  =====================
  An open source QR code utility for generating, incrementing, and cloning QR codes in the browser.

  Author: GrandMasterFunk
  License: MIT
  Repository: https://github.com/psems/pfos (update with actual repo URL)
  Version: 0.0.7
  Date: 2025-06-27

  Description:
    Pocket Full of Sunshine is a simple, browser-based tool for generating QR codes from text, incrementing numbers, or cloning existing QR codes via camera scan. It supports logging, marking, and downloading QR code generation history. No backend required.

  Usage:
    - Select a mode: Text, Increment, or Clone QR
    - Enter your data or scan a QR code
    - Generate and interact with QR codes directly in your browser
    - Mark and download your QR code log for record-keeping

  Contributions welcome! Please see the repository for details.
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pocket Full of Sunshine</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <h2>Pocket Full of Sunshine</h2>

  <select id="mode-select">   
    <option value="clone" selected>Clone QR</option>
    <option value="increment">Increment</option>
    <option value="text">Text</option>
  </select>

  <div id="text-mode">
    <input type="text" id="text-input" placeholder="Enter text" value="Groovy!" inputmode="text">
    <button onclick="generateTextQR()">Generate QR</button>
  </div>

  <div id="increment-mode" class="hidden">
    <input type="number" id="start-number" placeholder="Start number" inputmode="numeric" pattern="[0-9]*" value="1">
    <input type="number" id="increment-step" placeholder="Step" value="1" inputmode="numeric" pattern="[0-9]*">
    <button onclick="startIncrementQR()">Start</button>
  </div>

  <div id="clone-mode" class="hidden">
    <div id="reader"></div>
    <input type="text" id="clone-input" placeholder="Scan or edit QR content" value="CLONE ME!">
    <button id="generate-clone-btn" onclick="generateCloneQR()">Generate QR</button>
    <button id="scan-qr-btn" type="button" onclick="startCamera()">Scan QR Code</button>
  </div>

  <div id="qr"></div>

  <button id="increment-btn" class="hidden" onclick="incrementAndGenerateQR()">INCREMENT</button>
  <button id="mark-btn" onclick="markCurrent()">MARK</button>
  <button onclick="downloadLog()">Download Log</button>

  <textarea id="log" readonly></textarea>

  <!-- QR Libraries: local copies for reliability -->
  <script src="qrcode.min.js"></script>
  <script src="html5-qrcode.min.js"></script>

  <script>
    let qr;
    let currentNumber = 0;
    let incrementStep = 1;
    let isIncrementMode = false;
    let currentValue = '';
    const logArea = document.getElementById('log');

    function clearQR() {
      document.getElementById('qr').innerHTML = "";
    }

    function logEntry(value, marked = false, dateOnly = false) {
      let entry;
      if (dateOnly) {
        // Log only the date in YYYY-MM-DD format
        const date = new Date().toISOString().slice(0, 10);
        entry = `--- ${date} ---`;
      } else {
        // Log time in 24-hour format
        const now = new Date();
        const time = now.toLocaleTimeString('en-GB', { hour12: false });
        entry = `${time} - ${value}${marked ? " [MARKED]" : ""}`;
      }
      logArea.value += entry + "\n";
      logArea.scrollTop = logArea.scrollHeight;
    }

    function generateTextQR() {
      isIncrementMode = false;
      const text = document.getElementById('text-input').value;
      currentValue = text;
      clearQR();
      qr = new QRCode(document.getElementById("qr"), {
        text: text,
        width: 256,
        height: 256,
        colorDark: "#00ff00",
        colorLight: "#000000"
      });
      logEntry(text);
    }

    function startIncrementQR() {
      isIncrementMode = true;
      currentNumber = parseInt(document.getElementById('start-number').value, 10);
      incrementStep = parseInt(document.getElementById('increment-step').value, 10);
      generateIncrementQR();
    }

    function generateIncrementQR() {
      currentValue = currentNumber.toString();
      clearQR();
      qr = new QRCode(document.getElementById("qr"), {
        text: currentValue,
        width: 256,
        height: 256,
        colorDark: "#00ff00",
        colorLight: "#000000"
      });
      logEntry(currentValue);
    }

    function markCurrent() {
      if (currentValue !== '') {
        logEntry(currentValue, true);
      }
    }

    function downloadLog() {
      const blob = new Blob([logArea.value], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'qr-log.txt';
      a.click();
      URL.revokeObjectURL(url);
    }

    function generateCloneQR() {
      const text = document.getElementById('clone-input').value;
      currentValue = text;
      clearQR();
      qr = new QRCode(document.getElementById("qr"), {
        text: text,
        width: 256,
        height: 256,
        colorDark: "#00ff00",
        colorLight: "#000000"
      });
      logEntry("Cloned: " + text);
    }

    function incrementAndGenerateQR() {
      if (isIncrementMode) {
        currentNumber += incrementStep;
        generateIncrementQR();
      }
    }

    document.getElementById('mode-select').addEventListener('change', function () {
      ['text', 'increment', 'clone'].forEach(mode => {
        document.getElementById(`${mode}-mode`).classList.add('hidden');
      });

      const selected = this.value;
      document.getElementById(`${selected}-mode`).classList.remove('hidden');
      clearQR();

      // Log the date when changing mode
      logEntry('', false, true);

      // Show or hide the increment button
      document.getElementById('increment-btn').classList.toggle('hidden', selected !== 'increment');

      const scanBtn = document.getElementById('scan-qr-btn');
      if (scanBtn) scanBtn.style.display = (selected === 'clone') ? '' : 'none';

      if (selected === 'clone') {
        generateCloneQR();
        stopCamera();
      } else if (selected === 'increment') {
        startIncrementQR();
      } else {
        generateTextQR();
      }
      if (selected !== 'clone') {
        stopCamera();
      }
    });

    // Generate default QR code on load
    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('mode-select').value = 'clone';
      ['text', 'increment', 'clone'].forEach(mode => {
        document.getElementById(`${mode}-mode`).classList.add('hidden');
      });
      document.getElementById('clone-mode').classList.remove('hidden');
      clearQR();
      // Show initial QR code for the default mode
      const mode = document.getElementById('mode-select').value;
      document.getElementById('increment-btn').classList.toggle('hidden', mode !== 'increment');
      const scanBtn = document.getElementById('scan-qr-btn');
      if (scanBtn) scanBtn.style.display = (mode === 'clone') ? '' : 'none';
      if (mode === 'clone') {
        generateCloneQR();
        stopCamera();
      } else if (mode === 'increment') {
        startIncrementQR();
      } else {
        generateTextQR();
      }
      // Log the date on initial load
      logEntry('', false, true);
    });

    let scanner;

    function startCamera() {
      stopCamera();
      const scanBtn = document.getElementById('scan-qr-btn');
      if (scanBtn) scanBtn.style.display = 'none';
      const readerDiv = document.getElementById('reader');
      readerDiv.innerHTML = '';
      readerDiv.classList.remove('hidden');
      if (typeof Html5Qrcode === 'undefined') {
        alert('QR scanner library not loaded.');
        console.error('Html5Qrcode is undefined.');
        if (scanBtn) scanBtn.style.display = '';
        return;
      }
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert('Camera API not supported in this browser.');
        console.error('mediaDevices.getUserMedia not available.');
        if (scanBtn) scanBtn.style.display = '';
        return;
      }
      if (typeof navigator.permissions !== 'undefined' && navigator.permissions.query) {
        navigator.permissions.query({ name: 'camera' }).then(function(result) {
          console.log('Camera permission state:', result.state);
        }).catch(function(e) {
          console.log('Camera permission query not supported:', e);
        });
      }
      try {
        scanner = new Html5Qrcode("reader");
        scanner.start({ facingMode: { exact: "environment" } }, {
          fps: 10,
          qrbox: 250
        }, qrCodeMessage => {
          document.getElementById('clone-input').value = qrCodeMessage;
          stopCamera();
        }).catch(err => {
          console.error('Camera start error:', err);
          alert("Camera access failed. Please check permissions, HTTPS, and try refreshing the page.\nError: " + err);
          stopCamera();
        });
      } catch (err) {
        console.error('Camera init error:', err);
        alert("Camera initialization failed.\nError: " + err);
        if (scanBtn) scanBtn.style.display = '';
      }
    }

    function stopCamera() {
      const readerDiv = document.getElementById('reader');
      const scanBtn = document.getElementById('scan-qr-btn');
      if (scanner) {
        scanner.stop().then(() => {
          scanner.clear();
          scanner = null;
          if (readerDiv) readerDiv.innerHTML = '';
          if (scanBtn && document.getElementById('mode-select').value === 'clone') scanBtn.style.display = '';
        }).catch(err => {
          console.error('Camera stop error:', err);
          scanner = null;
          if (readerDiv) readerDiv.innerHTML = '';
          if (scanBtn && document.getElementById('mode-select').value === 'clone') scanBtn.style.display = '';
        });
      } else {
        if (readerDiv) readerDiv.innerHTML = '';
        if (scanBtn && document.getElementById('mode-select').value === 'clone') scanBtn.style.display = '';
      }
      if (readerDiv && document.getElementById('mode-select').value !== 'clone') {
        readerDiv.classList.add('hidden');
      }
      if (scanBtn && document.getElementById('mode-select').value !== 'clone') scanBtn.style.display = 'none';
    }
  </script>
</body>
</html>
